## 요약

|       | 순서                                                         | DOMContentLoaded                                             |
| ----- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| async | *load-first order*. 문서 내 순서와 상관없이 먼저 다운로드된 스크립트가 먼저 실행됩니다. | 비동기 스크립트는 HTML 문서가 완전히 다운로드되지 않은 상태라도 로드 및 실행될 수 있습니다. 스크립트 크기가 작거나 캐싱 처리 되어있을 때 혹은 HTML 문서 길이가 아주 길 때 이런 일이 발생합니다. |
| defer | 문서에 추가된 순                                             | 지연 스크립트는 문서 다운로드와 파싱이 완료된 후에, DOMContentLoaded 이벤트 발생 전에 실행됩니다. |



## 스토리텔링

#### 배경지식 - 렌더링 과정

- 렌더링 엔진은 HTML을 한줄씩 순차적으로 파싱한다. 만약 도중에 script태그를 만나면 제어권이 자바스크립트 엔진으로 넘어가며, 자바스크립트의 파싱과 실행을 처리한다. 

#### 주의사항

- 만약 DOM 생성이 모두 완료되지 않은 시점에서 자바스크립트가 DOM을 조작하면 에러가 발생할 수 있다.
- 자바스크립트 로딩/파싱/실행으로 인해 HTML 요소들의 렌더링에 지장받는 일이 발생한다면 페이지 로딩 시간이 연장된다.

#### 해결방안

- script 태그를 HTML 파일의 맨 아래에 놓는다.

#### 한계점

- 만약 HTML 문서 자체가 매우 크다면, 브라우저가 HTML 문서 전체를 다운로드 한 다음 스크립트를 다운받게 되어 페이지가 정말 느려질 것이다.

#### 등장배경

- DOM 생성이 중단되는 문제를 근본적으로 해결하기 위해 HTML5부터 script 태그에 async와 defer 어트리뷰트가 추가되었다.



#### async와 defer의 공통점

- src 어트리뷰트를 통해 외부 자바스크립트 파일을 로드하는 경우에만 사용할 수 있다. 즉, src 어트리뷰트가 없는 인라인 자바스크립트에는 사용불가

- HTML 파싱과 외부 자바크스립트 파일의 로드가 비동기적으로 동시에 진행된다.
- 다운로드 시 페이지 렌더링을 막지 않는다. 따라서 async와 defer를 적절히 사용하면 사용자가 오래 기다리지 않고 페이지 콘텐츠를 볼 수 있게 할 수 있다.

#### async 어트리뷰트

- 여러개의 script에 async 어트리뷰트를 지정하면, script 태그의 순서와는 상관없이 **로드가 완료된 자바스크립트부터** 먼저 실행되므로 순서가 보장되지 않는다. 따라서 순서 보장이 필요한 script 태그에는 async 어트리뷰트를 쓰면 안됨
- 브라우저는 `defer` 속성이 있는 스크립트(이하 defer 스크립트 또는 지연 스크립트)를 '백그라운드’에서 다운로드한다. 따라서 지연 스크립트를 다운로드 하는 도중에도 HTML 파싱이 멈추지 않는다. 그리고 `defer` 스크립트 실행은 페이지 구성이 끝날 때까지 *지연* 된다.
- 지연 스크립트는 페이지 생성을 절대 막지 않는다.
- 지연 스크립트는 DOM이 준비된 후에 실행되긴 하지만 `DOMContentLoaded` 이벤트 발생 전에 실행된다.

#### defer 어트리뷰트

- 자바스크립트의 파싱과 실행은 자바스크립트 파일의 로드가 완료된 직후, 즉 DOM 생성이 완료된 직후(DOMContentLoaded이벤트가 발생)에 진행된다. 따라서 DOM 생성이 완료된 이후 실행되어야할 자바스크립트에 유용하다.

- `async` 속성이 붙은 스크립트(이하 async 스크립트 또는 비동기 스크립트)는 페이지와 완전히 독립적으로 동작한다.

- async 스크립트는 defer 스크립트와 마찬가지로 백그라운드에서 다운로드된다. 따라서 HTML 페이지는 async 스크립트 다운이 완료되길 기다리지 않고 페이지 내 콘텐츠를 처리, 출력합니다(하지만 async 스크립트 실행중에는 HTML 파싱이 멈춘다. -  옮긴이(출처 https://ko.javascript.info/script-async-defer)).
- DOMContentLoaded 이벤트와 async 스크립트는 서로를 기다리지 않는다.
  - 페이지 구성이 끝난 후에 async 스크립트 다운로딩이 끝난 경우, `DOMContentLoaded`는 async 스크립트 실행 전에 발생할 수 있습니다,
  - async 스크립트가 짧아서 페이지 구성이 끝나기 전에 다운로드 되거나 스크립트가 캐싱처리 된 경우, `DOMContentLoaded`는 `async` 스크립트 실행 후에 발생할 수도 있습니다.
- 다른 스크립트들은 `async` 스크립트를 기다리지 않는다.. `async` 스크립트 역시 다른 스크립트들을 기다리지 않는다.

- 이런 특징 때문에 페이지에 `async` 스크립트가 여러 개 있는 경우, 그 실행 순서가 제각각이 된다.. 실행은 다운로드가 끝난 스크립트 순으로 진행된다.

## reference

1 https://ko.javascript.info/script-async-defer

2 자바스크립트 Deep Dive(38장 브라우저의 렌더링 과정, 이웅모, 위키북스)

